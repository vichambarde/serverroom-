{% extends "base.html" %}

{% block title %}Scan QR Code - User - Inventory Management System{% endblock %}

{% block extra_css %}
<style>
    #reader {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="mb-3">
            <a href="{{ url_for('user.dashboard') }}" class="btn btn-outline-light">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-qr-code-scan"></i> Scan QR Code</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Point your camera at a QR code to scan it
                </div>
                
                <div id="reader"></div>
                
                <div id="result" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <h5>QR Code Detected!</h5>
                        <p id="result-text"></p>
                        <button class="btn btn-primary" id="proceed-btn">
                            Proceed to Item
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
function onScanSuccess(decodedText, decodedResult) {
    console.log(`QR Code detected: ${decodedText}`);
    
    // Parse QR code data (format: ITEM_ID:123|NAME:Item Name)
    const parts = decodedText.split('|');
    let itemId = null;
    let itemName = null;
    
    parts.forEach(part => {
        if (part.startsWith('ITEM_ID:')) {
            itemId = part.replace('ITEM_ID:', '');
        } else if (part.startsWith('NAME:')) {
            itemName = part.replace('NAME:', '');
        }
    });
    
    if (itemId) {
        // Stop scanning
        html5QrcodeScanner.clear();
        
        // Show result
        document.getElementById('result').style.display = 'block';
        document.getElementById('result-text').textContent = `Item: ${itemName || 'Unknown'} (ID: ${itemId})`;
        
        // Set up proceed button
        document.getElementById('proceed-btn').onclick = function() {
            window.location.href = `/user/take/${itemId}`;
        };
    } else {
        alert('Invalid QR code format. Please scan a valid item QR code.');
    }
}

function onScanFailure(error) {
    // Handle scan failure, usually better to ignore
    // console.warn(`QR Code scan error: ${error}`);
}

// Initialize QR Code Scanner
const html5QrcodeScanner = new Html5QrcodeScanner(
    "reader",
    { 
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0
    },
    /* verbose= */ false
);

html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>
{% endblock %}
